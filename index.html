<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Etikett scannen</title>
  <style>
    body{font-family:system-ui,-apple-system,BlinkMacSystemFont,sans-serif;background:#f5f5f5;padding:16px}
    .card{background:#fff;padding:16px;border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,.1);max-width:560px;margin:auto}
    input,button,select{width:100%;padding:10px;margin-top:10px;font-size:16px;box-sizing:border-box}
    button{background:#0066cc;color:#fff;border:none;border-radius:6px;cursor:pointer}
    button:disabled{background:#999;cursor:not-allowed}
    img{max-width:100%;margin-top:10px;border-radius:6px}
    .status{margin-top:10px;padding:10px;border-radius:6px;line-height:1.35;white-space:pre-wrap}
    .ok{background:#e0f6e9}.err{background:#fde2e2}
    pre{background:#f0f0f0;padding:10px;overflow-x:auto;border-radius:6px;margin-top:10px}
    .hint{color:#444;font-size:13px;margin-top:6px;line-height:1.35}
    .row{display:flex;gap:10px;align-items:center}
    .row > *{flex:1}
    label{display:block;margin-top:10px;font-size:14px;color:#333}
    .small{font-size:12px;color:#555;margin-top:6px}
    .actions{display:flex;gap:10px;margin-top:10px}
    .actions button{flex:1}
    .secondary{background:#444}
  </style>
</head>
<body>
  <div class="card">
    <h2>Etikett scannen</h2>

    <input id="webhookUrl" placeholder="n8n Webhook-URL (https://…)" autocomplete="off" />
    <div class="hint">Wird lokal im Browser gespeichert (damit du es nicht jedes Mal eingeben musst).</div>

    <input id="apiKey" placeholder="API Key (optional)" autocomplete="off" />
    <div class="hint">Optional. Wenn gesetzt, wird als <code>Authorization: Bearer …</code> gesendet. Kann ebenfalls lokal gespeichert werden.</div>

    <div class="actions">
      <button id="saveBtn" class="secondary" type="button">URL/Key merken</button>
      <button id="clearBtn" class="secondary" type="button">Merken löschen</button>
    </div>
    <div class="small">Hinweis: „Merken“ speichert in <b>localStorage</b> auf diesem Gerät/Browser. Nicht verwenden auf fremden Geräten.</div>

    <label for="maxDim">Foto-Größe (iPhone-Stabilität):</label>
    <div class="row">
      <select id="maxDim">
        <option value="1024">1024 px (max. stabil)</option>
        <option value="1280">1280 px (sehr stabil)</option>
        <option value="1600" selected>1600 px (empfohlen)</option>
        <option value="2048">2048 px (mehr Details)</option>
      </select>
      <select id="jpegQ">
        <option value="0.70">JPEG 70%</option>
        <option value="0.80">JPEG 80%</option>
        <option value="0.85" selected>JPEG 85% (empfohlen)</option>
        <option value="0.92">JPEG 92%</option>
      </select>
    </div>

    <input id="fileInput" type="file" accept="image/*" capture="environment" />

    <img id="preview" style="display:none" alt="Vorschau" />

    <button id="scanBtn" disabled>Scannen</button>

    <div id="status" class="status" style="display:none"></div>
    <pre id="result" style="display:none"></pre>
  </div>

<script>
const LS_URL_KEY = 'labelScanner.webhookUrl';
const LS_API_KEY = 'labelScanner.apiKey';

const webhookEl = document.getElementById('webhookUrl');
const apiKeyEl = document.getElementById('apiKey');
const saveBtn = document.getElementById('saveBtn');
const clearBtn = document.getElementById('clearBtn');

const fileInput = document.getElementById('fileInput');
const preview = document.getElementById('preview');
const scanBtn = document.getElementById('scanBtn');
const statusEl = document.getElementById('status');
const resultEl = document.getElementById('result');
const maxDimEl = document.getElementById('maxDim');
const jpegQEl = document.getElementById('jpegQ');

let jpegBlob = null;
let previewUrl = null;

function showStatus(text, ok = true) {
  statusEl.style.display = 'block';
  statusEl.textContent = text;
  statusEl.className = 'status ' + (ok ? 'ok' : 'err');
}

function revokePreviewUrl() {
  if (previewUrl) {
    URL.revokeObjectURL(previewUrl);
    previewUrl = null;
  }
}

async function blobToBase64(blob) {
  return await new Promise((resolve, reject) => {
    const r = new FileReader();
    r.onload = () => resolve(String(r.result).split(',')[1]);
    r.onerror = reject;
    r.readAsDataURL(blob);
  });
}

// --- Persistenz ---
function loadSaved() {
  const savedUrl = localStorage.getItem(LS_URL_KEY);
  const savedKey = localStorage.getItem(LS_API_KEY);
  if (savedUrl) webhookEl.value = savedUrl;
  if (savedKey) apiKeyEl.value = savedKey;
}
function saveCurrent() {
  const url = webhookEl.value.trim();
  const key = apiKeyEl.value.trim();
  if (url) localStorage.setItem(LS_URL_KEY, url); else localStorage.removeItem(LS_URL_KEY);
  if (key) localStorage.setItem(LS_API_KEY, key); else localStorage.removeItem(LS_API_KEY);
  showStatus('Gespeichert.', true);
  setTimeout(() => { statusEl.style.display = 'none'; }, 1200);
}
function clearSaved() {
  localStorage.removeItem(LS_URL_KEY);
  localStorage.removeItem(LS_API_KEY);
  showStatus('Gespeicherte Werte gelöscht.', true);
  setTimeout(() => { statusEl.style.display = 'none'; }, 1200);
}
saveBtn.addEventListener('click', saveCurrent);
clearBtn.addEventListener('click', clearSaved);
webhookEl.addEventListener('change', saveCurrent);
apiKeyEl.addEventListener('change', saveCurrent);

// --- Bild laden & resizen (mit Fallback) ---
async function loadBitmapFallback(file) {
  // Fallback: FileReader -> Image -> draw
  const dataUrl = await new Promise((resolve, reject) => {
    const r = new FileReader();
    r.onload = () => resolve(r.result);
    r.onerror = reject;
    r.readAsDataURL(file);
  });

  const img = await new Promise((resolve, reject) => {
    const i = new Image();
    i.onload = () => resolve(i);
    i.onerror = reject;
    i.src = dataUrl;
  });

  // Wir geben ein Objekt mit width/height und einem drawImage-kompatiblen Source zurück
  return { src: img, width: img.naturalWidth || img.width, height: img.naturalHeight || img.height };
}

fileInput.addEventListener('change', async (e) => {
  const file = e.target.files && e.target.files[0];
  if (!file) return;

  scanBtn.disabled = true;
  resultEl.style.display = 'none';
  showStatus('Foto wird vorbereitet…');

  try {
    let source, sw, sh;

    // Versuch 1: createImageBitmap
    try {
      const bitmap = await createImageBitmap(file);
      source = bitmap;
      sw = bitmap.width;
      sh = bitmap.height;
    } catch (err1) {
      // Fallback
      const fb = await loadBitmapFallback(file);
      source = fb.src;
      sw = fb.width;
      sh = fb.height;
    }

    const maxDim = parseInt(maxDimEl.value, 10);
    const scale = Math.min(1, maxDim / Math.max(sw, sh));
    const w = Math.max(1, Math.round(sw * scale));
    const h = Math.max(1, Math.round(sh * scale));

    const canvas = document.createElement('canvas');
    canvas.width = w;
    canvas.height = h;
    const ctx = canvas.getContext('2d', { alpha: false });
    ctx.drawImage(source, 0, 0, w, h);

    const q = parseFloat(jpegQEl.value);
    jpegBlob = await new Promise((resolve) => canvas.toBlob(resolve, 'image/jpeg', q));
    if (!jpegBlob) throw new Error('JPEG-Konvertierung fehlgeschlagen');

    revokePreviewUrl();
    previewUrl = URL.createObjectURL(jpegBlob);
    preview.src = previewUrl;
    preview.style.display = 'block';

    showStatus(`Foto bereit (${w}×${h}, ${(jpegBlob.size/1024/1024).toFixed(2)} MB)`);
    scanBtn.disabled = false;
  } catch (err) {
    console.error(err);
    jpegBlob = null;
    revokePreviewUrl();
    preview.style.display = 'none';
    showStatus('Foto konnte nicht verarbeitet werden.\nTipp: iPhone Einstellungen → Kamera → Formate → „Kompatibelste“.', false);
    scanBtn.disabled = true;
  }
});

scanBtn.addEventListener('click', async () => {
  const url = webhookEl.value.trim();
  if (!url) { showStatus('Bitte Webhook-URL eintragen', false); return; }
  if (!jpegBlob) { showStatus('Kein Foto vorhanden', false); return; }

  saveCurrent();

  showStatus('Etikett wird analysiert…');
  scanBtn.disabled = true;

  try {
    const base64 = await blobToBase64(jpegBlob);

    const headers = { 'Content-Type': 'application/json' };
    const apiKey = apiKeyEl.value.trim();
    if (apiKey) headers['Authorization'] = 'Bearer ' + apiKey;

    const res = await fetch(url, {
      method: 'POST',
      headers,
      body: JSON.stringify({ image: base64, image_type: 'image/jpeg' })
    });

    if (!res.ok) {
      let detail = '';
      try { detail = await res.text(); } catch (_) {}
      throw new Error('HTTP ' + res.status + (detail ? (': ' + detail.slice(0, 300)) : ''));
    }

    const data = await res.json();
    resultEl.style.display = 'block';
    resultEl.textContent = JSON.stringify(data, null, 2);
    showStatus('Erfolgreich gescannt');
  } catch (err) {
    console.error(err);
    showStatus('Fehler beim Scannen: ' + err.message, false);
  } finally {
    scanBtn.disabled = false;
  }
});

loadSaved();
</script>
</body>
</html>
